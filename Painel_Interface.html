<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle Financeiro de Projetos</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-color: #072380;
            --glass-bg: linear-gradient(135deg, rgba(240, 248, 255, 0.2) 0%, rgba(240, 248, 255, 0.3) 20%);
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #1a202c;
            background-image: linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.7)), url('https://i.imgur.com/oWpnttn.jpeg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            color: #052b63;
        }
        table { font-family: 'Poppins', sans-serif; }
        .glass-card {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(2px);
            backdrop-filter: blur(1.5px);
            border: 1px solid rgba(255, 255, 255, 0.0);
            border-radius: 0 60px 60px 60px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button.active {
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--primary-color);
        }
        .chart-container {
            position: relative;
            height: 45vh;
            min-height: 350px;
            max-height: 500px;
            width: 100%;
        }
        #map {
            height: 60vh;
            min-height: 400px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        @media (max-height: 800px) {
            .chart-container { height: 40vh; }
            body { font-size: 0.9rem; }
        }
        .message-box {
            background: linear-gradient(to bottom right, rgba(240, 248, 255, 0.9), rgba(240, 248, 255, 0.7));
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #333;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 500;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* --- ESTILO DOS ÍCONES --- */
        .custom-pin-icon {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 28px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 0.25px 0 black) drop-shadow(0 -0.25px 0 black) drop-shadow(0.25px 0 0 black) drop-shadow(-0.25px 0 0 black);
            z-index: 1000 !important;
        }
        .map-label-tooltip {
            font-family: 'Nunito', sans-serif !important;
            background: transparent !important;
            color: white !important;
            -webkit-text-stroke: 4px black;
            paint-order: stroke fill;
            text-shadow: none !important;
            font-weight: 800 !important;
            font-size: 1.25rem !important;
            padding: 0.25rem 0.5rem !important;
            border: none !important;
            text-shadow: 0px 1px 3px rgba(0,0,0,0.8);
            white-space: nowrap;
            box-shadow: none !important;
        }
        .leaflet-tooltip.map-label-tooltip.leaflet-tooltip-bottom:before {
            border-top-color: transparent !important;
        }
        .text-status-adiantado, .text-status-diff-blue { color: #0073a1; }
        .text-status-atrasado, .text-status-diff-red { color: #b80404; }
        #contractSelector { color: #333333; }
        #login-container { transition: opacity 0.5s ease-in-out; }
        #login-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="text-slate-200">

    <div id="login-container" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-90 z-50">
        <div class="glass-card p-8 rounded-xl shadow-lg w-96 text-center" style="border-radius: 1rem;">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Acesso Restrito</h2>
            <input type="password" id="password-input" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800" placeholder="Digite a senha"/>
            <button id="login-button" class="w-full bg-[#072380] text-white font-bold py-3 px-6 rounded-lg hover:bg-[#052b63] transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">Entrar</button>
            <p id="login-error" class="text-red-600 mt-3 hidden">Senha incorreta.</p>
        </div>
    </div>

    <div class="container mx-auto p-2 md:p-4 min-h-screen flex flex-col">

        <header class="text-center mb-2 relative" id="mainHeader">
            <div class="grid grid-cols-3 items-center gap-2 mb-2"> 
                <div class="flex justify-start">
                    <img src="" id="logoPOE" alt="Logo POE" class="h-12 md:h-14 max-w-full object-contain"/>
                </div>
                <div class="flex justify-center">
                    <img src="" id="logoJundiai" alt="Logo Jundiaí" class="h-16 md:h-20 max-w-full object-contain"/>
                </div>
                <div class="flex justify-end">
                    <img src="" id="logoCAF" alt="Logo CAF" class="h-16 md:h-20 max-w-full object-contain"/>    
                </div>
            </div>

            <h1 class="text-2xl md:text-3xl font-bold mb-1" style="color: black;">PROGRAMA AVANÇA JUNDIAÍ - ETAPA 2</h1>
            <div class="glass-card p-1 text-center w-fit mx-auto" style="border-top-right-radius: 50px; border-bottom-left-radius: 50px;">
                <p class="text-[#052b63] text-sm md:text-base font-bold px-4">Análise de performance de contratos de obras.</p>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <div class="glass-card p-2 text-center flex flex-col justify-center">
                <p class="text-xs text-gray-700 font-semibold uppercase">Obras em Andamento</p>
                <p id="totalContracts" class="text-2xl font-bold" style="color: #072380;">0</p>
            </div>
            <div class="glass-card p-2 text-center flex flex-col justify-center">
                <p class="text-xs text-gray-700 font-semibold uppercase">Valor Total Contratos</p>
                <p id="totalContractValue" class="text-2xl font-bold" style="color: #072380;">R$ 0,00</p>
            </div>
            <div class="glass-card p-2 text-center flex flex-col justify-center">
                <p class="text-xs text-gray-700 font-semibold uppercase">Medições (Último Mês)</p>
                <p id="sumOfLatestMonthlyMeasurements" class="text-2xl font-bold" style="color: #072380;">-</p>
            </div>
        </div>

        <div id="mapView" class="glass-card p-4 sm:p-6" style="border-radius: 1rem;">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Selecione uma Obra no Mapa</h2>
            <div id="map"></div>
            <p class="text-gray-700 text-sm mt-4 text-center">Clique em um marcador no mapa para ver os detalhes financeiros do contrato.</p>
        </div>

        <div id="dashboardView" class="glass-card p-4 sm:p-6 hidden" style="border-radius: 1rem;">
            <div class="flex justify-between items-center mb-6">
                <button id="backToMapButton" class="px-4 py-2 rounded-lg shadow transition-colors font-bold hover:bg-slate-200" style="background-color: transparent; color: #072380; border: 1px solid #072380;">
                    ← Voltar ao Mapa
                </button>
                <div class="flex-grow ml-4">
                    <label for="contractSelector" class="block text-sm font-semibold text-gray-700 mb-1">Selecione Outro Contrato:</label>
                    <select id="contractSelector" class="w-full p-3 bg-white/80 border border-slate-300 rounded-xl shadow-sm focus:ring-2 focus:ring-blue-500 text-gray-900"></select>
                </div>
            </div>

            <div class="flex justify-start gap-2 mb-4">
                <button id="exportChartPngButton" title="Exportar PNG" class="p-1 w-8 h-8 rounded-lg shadow flex items-center justify-center font-bold hover:bg-green-100/50"><i class="fas fa-file-image text-2xl text-gray-800"></i></button>
                <button id="exportTableCsvButton" title="Exportar CSV" class="p-1 w-8 h-8 rounded-lg shadow flex items-center justify-center font-bold hover:bg-orange-100/50"><i class="fas fa-file-csv text-2xl text-gray-800"></i></button>
                <button id="exportPdfButton" title="Exportar PDF" class="p-1 w-8 h-8 rounded-lg shadow flex items-center justify-center font-bold hover:bg-red-100/50"><i class="fas fa-file-pdf text-2xl text-gray-800"></i></button>
                <button id="exportRouteButton" title="Gerar Rota no Google Maps" class="p-1 w-8 h-8 rounded-lg shadow flex items-center justify-center font-bold hover:bg-teal-100/50"><i class="fas fa-route text-2xl text-gray-800"></i></button>
            </div>

            <main>
                <div id="contractDetails" class="mb-6 border-b border-white/50 pb-6 flex flex-col items-center text-center"></div>

                <div class="mb-4">
                    <div class="bg-slate-200/50 rounded-xl p-1 inline-flex space-x-1">
                        <button id="tab-chart" class="tab-button flex items-center gap-2 whitespace-nowrap py-2 px-4 rounded-lg font-bold text-sm text-slate-600 hover:bg-white/60 transition-all">Gráfico Comparativo</button>
                        <button id="tab-table" class="tab-button flex items-center gap-2 whitespace-nowrap py-2 px-4 rounded-lg font-bold text-sm text-slate-600 hover:bg-white/60 transition-all">Tabela de Medições</button>
                    </div>
                </div>

                <div id="content-chart" class="content-view mb-8">
                    <p class="text-gray-700 text-sm mb-4 text-center">Comparação mensal 'Previsto' vs 'Executado'.</p>
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                    <div id="noChartDataMessage" class="message-box">
                        <p class="font-semibold text-gray-700">Não há dados de gráfico disponíveis.</p>
                        <p class="text-sm text-gray-600">Visualize os dados na tabela de cronograma.</p>
                    </div>
                </div>

                <div id="content-table" class="content-view hidden mt-8">
                    <p class="text-gray-700 text-sm mb-4">Tabela detalhada de medições.</p>
                    <div id="comparativeTableContainer" class="overflow-x-auto hidden">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Medição</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Mês</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Prev. Mês</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Prev. Acum.</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Exec. Mês</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Exec. Acum.</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Diferença</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="comparativeTableBody"></tbody>
                        </table>
                    </div>
                    <div id="predictedScheduleTableContainer" class="overflow-x-auto hidden">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Medição</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Período</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Ref.</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Valor Medição</th>
                                    <th class="px-5 py-3 text-center text-xs font-semibold text-gray-700 uppercase">Valor Acumulado</th>
                                </tr>
                            </thead>
                            <tbody id="measurementsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <footer class="text-center mt-auto py-6 text-sm text-[#CCCCCC]">
            <p>Painel gerado com base nos dados de cada contratação.</p>
        </footer>
    </div>

    <script src="Dados_Contrato.js"></script>

    <script>
        /**
         * Arquitetura do Painel: Padrão Modular (IIFE)
         */
        const DashboardApp = (() => {
            
            // --- Configurações Centralizadas ---
            const CONFIG = {
                // TOKEN BASE64 DA SENHA "AVANCA!2025" (Compatível com modo offline/arquivo)
                AUTH_TOKEN: "QVZBTkNBITIwMjU=", 
                COORDS_PREFEITURA: { lat: -23.1857, lng: -46.8978 },
                COLORS: {
                    PRIMARY: '#072380',
                    SUCCESS: '#0073a1',
                    DANGER: '#b80404',
                    EXEC: '#007B3D',
                    PREV_1: '#9333ea',
                    PREV_2: '#007BFF',
                    PREV_3: '#CC5200'
                },
                IMAGES: {
                    logoCAF: "https://i.imgur.com/1JpcXBq.png",
                    logoJundiai: "https://i.imgur.com/QpfUWkv.png",
                    logoPOE: "https://i.imgur.com/67zLDAk.png",
                    logoUBS: "https://i.imgur.com/syy1cBb.png",
                    logoAtleta: "https://i.imgur.com/w2G3qli.png",
                    SymbolUBS: "https://i.imgur.com/7uzXtjt.png",
                    SymbolEMEB: "https://i.imgur.com/W7VfPAS.png",
                    SymbolCECE: "https://i.imgur.com/rAIR7HJ.png",
                    SymbolCEPA: "https://i.imgur.com/0echur2.png",
                    SymbolPOP: "https://i.imgur.com/zCOljOs.png",
                    SymbolSCamilo: "https://i.imgur.com/wAsmKzd.png",
                    logoEscola: "https://i.imgur.com/F9Zk9Qt.png"
                }
            };

            const ICONS = {
                "EMEB": { type: 'image', url: CONFIG.IMAGES.SymbolEMEB, colorClass: '' },
                "CECE": { type: 'image', url: CONFIG.IMAGES.SymbolCECE, colorClass: '' },
                "UBS": { type: 'image', url: CONFIG.IMAGES.SymbolUBS, colorClass: '' },
                "CEPA": { type: 'image', url: CONFIG.IMAGES.SymbolCEPA, colorClass: '' }, 
                "POP": { type: 'image', url: CONFIG.IMAGES.SymbolPOP, colorClass: '' }, 
                "Camilo": { type: 'image', url: CONFIG.IMAGES.SymbolSCamilo, colorClass: '' }, 
                "default": { type: 'image', url: '', colorClass: '' }
            };

            let state = {
                mapInstance: null,
                chartInstance: null
            };

            // --- Helpers ---
            const Utils = {
                parseDate(dateString) {
                    if (!dateString || dateString === 'N/A') return null;
                    const parts = dateString.split('/');
                    if (parts.length !== 3) return null;
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const year = parseInt(parts[2], 10);
                    return new Date(year, month, day);
                },

                calculateTotalDays(startDate, endDate) {
                    if (!startDate || !endDate) return 0;
                    const diff = Math.abs(endDate - startDate);
                    return Math.ceil(diff / (1000 * 60 * 60 * 24));
                },

                formatCurrency(value) {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
                },

                formatCurrencyAndPercentage(value, total) {
                    if (value == null || total === 0) return this.formatCurrency(value);
                    const pct = ((value / total) * 100).toFixed(2);
                    return `${this.formatCurrency(value)} (${pct}%)`;
                },
                
                formatCompactCurrency(value) {
                    const abs = Math.abs(value);
                    if (abs >= 1e6) return `R$ ${(abs / 1e6).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })} mi`;
                    if (abs >= 1e3) return `R$ ${(abs / 1e3).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })} mil`;
                    return `R$ ${abs.toLocaleString('pt-BR')}`;
                },

                // XSS Protection Helper
                escapeHTML(str) {
                    if(typeof str !== 'string') return str;
                    return str.replace(/[&<>'"]/g, 
                        tag => ({
                            '&': '&amp;',
                            '<': '&lt;',
                            '>': '&gt;',
                            "'": '&#39;',
                            '"': '&quot;'
                        }[tag]));
                },

                // SHA-256 Generator
                async sha256(message) {
                    const msgBuffer = new TextEncoder().encode(message);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                }
            };

            // --- Componente: Autenticação Segura ---
            const Auth = {
                init() {
                    const btn = document.getElementById('login-button');
                    const input = document.getElementById('password-input');
                    const container = document.getElementById('login-container');
                    const errorMsg = document.getElementById('login-error');

                    const attemptLogin = () => {
                        // Converte o input para Base64 e compara (Funciona Offline)
                        // A senha continua sendo: AVANCA!2025
                        const inputToken = btoa(input.value);
                        
                        if (inputToken === CONFIG.AUTH_TOKEN) {
                            container.classList.add('hidden');
                            input.value = '';
                            App.init(); 
                        } else {
                            errorMsg.classList.remove('hidden');
                            input.value = '';
                            input.focus();
                        }
                    };

                    btn.addEventListener('click', attemptLogin);
                    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') attemptLogin(); });
                }
            };

            // --- Componente: Mapa ---
            const MapComponent = {
                init() {
                    state.mapInstance = L.map('map').setView([-23.185, -46.88], 12);
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles © Esri'
                    }).addTo(state.mapInstance);
                    this.renderMarkers();
                },

                renderMarkers() {
                    // projectData agora está no escopo global através do arquivo carregado
                    if (typeof window.projectData === 'undefined' || !Array.isArray(window.projectData)) {
                        console.error("Dados do projeto não carregados.");
                        return;
                    }

                    const bounds = [];
                    
                    window.projectData.forEach(p => {
                        if (!p.location || isNaN(parseFloat(p.location.lat)) || isNaN(parseFloat(p.location.lng))) return;

                        const lat = parseFloat(p.location.lat);
                        const lng = parseFloat(p.location.lng);

                        let iconConfig = ICONS.default;
                        if (p.objeto.includes("EMEB")) iconConfig = ICONS.EMEB;
                        else if (p.objeto.includes("CECE")) iconConfig = ICONS.CECE;
                        else if (p.objeto.includes("CEPA")) iconConfig = ICONS.CEPA;
                        else if (p.objeto.includes("POP")) iconConfig = ICONS.POP;
                        else if (p.objeto.includes("Camilo")) iconConfig = ICONS.Camilo;
                        else if (p.objeto.includes("UBS")) iconConfig = ICONS.UBS;

                        const htmlIcon = `<img src="${iconConfig.url}" alt="ícone" style="width: 100%; height: auto; display: block;">`;

                        const icon = L.divIcon({
                            className: `custom-pin-icon ${iconConfig.colorClass}`,
                            html: htmlIcon,
                            iconSize: [38, 38],
                            iconAnchor: [19, 19],
                            tooltipAnchor: [0, -19]
                        });

                        L.marker([lat, lng], { icon })
                            .addTo(state.mapInstance)
                            .bindTooltip(`<b>${Utils.escapeHTML(p.objeto)}</b>`, { 
                                direction: 'top', 
                                permanent: false,
                                className: 'map-label-tooltip', 
                                offset: L.point(0, -10) 
                            })
                            .on('click', () => ViewManager.showDashboard(p.id));

                        bounds.push([lat, lng]);
                    });

                    if (bounds.length) state.mapInstance.fitBounds(bounds, { padding: [50, 50] });
                }
            };

            // --- Componente: Gráfico (Chart.js) ---
            const ChartComponent = {
                createDatasetConfig(label, data, color, order, isExecutado) {
                    return {
                        label, data,
                        borderColor: color,
                        backgroundColor: color,
                        pointBackgroundColor: color,
                        pointBorderColor: color,
                        pointStyle: 'circle',
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        borderWidth: isExecutado ? 3 : 2,
                        borderDash: isExecutado ? [] : [5, 5],
                        tension: 0.4,
                        order: order,
                        datalabels: {
                            color: color,
                            align: isExecutado ? 'end' : 'start', 
                            anchor: isExecutado ? 'end' : 'start',
                            offset: 4,
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderRadius: 4,
                            padding: { top: 2, bottom: 2, left: 4, right: 4 },
                            font: { weight: 'bold', size: 11, family: 'Poppins' },
                            formatter: (val) => Utils.formatCompactCurrency(val),
                            display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== null
                        }
                    };
                },

                render(contract) {
                    if (state.chartInstance) state.chartInstance.destroy();

                    const canvas = document.getElementById('mainChart');
                    const noDataMsg = document.getElementById('noChartDataMessage');
                    const container = document.querySelector('#content-chart .chart-container');

                    let labels = contract.grafico?.labels || [];
                    let datasets = [];

                    // Previstos
                    if (contract.grafico?.previstoDataSets) {
                        const dsConfigs = [
                            { color: CONFIG.COLORS.PREV_1 },
                            { color: CONFIG.COLORS.PREV_2 },
                            { color: CONFIG.COLORS.PREV_3 }
                        ];
                        contract.grafico.previstoDataSets.forEach((ds, idx) => {
                            if (dsConfigs[idx]) {
                                datasets.push(this.createDatasetConfig(
                                    ds.label, ds.data, dsConfigs[idx].color, idx + 1, false
                                ));
                            }
                        });
                    } else if (contract.grafico?.previsto) {
                        datasets.push(this.createDatasetConfig(
                            'Previsto', contract.grafico.previsto, CONFIG.COLORS.PREV_3, 1, false
                        ));
                    }

                    // Executado
                    if (contract.grafico?.executado?.some(v => v !== null)) {
                        const execConfig = this.createDatasetConfig(
                            'Executado', contract.grafico.executado, CONFIG.COLORS.EXEC, 10, true
                        );
                        datasets.push(execConfig);
                        noDataMsg.style.display = 'none';
                        container.classList.remove('hidden');
                    } else {
                        noDataMsg.style.display = 'block';
                        container.classList.add('hidden');
                    }

                    if (datasets.length === 0) return;

                    state.chartInstance = new Chart(canvas, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: { padding: { top: 25, bottom: 5, left: 10, right: 10 } },
                            scales: {
                                y: { 
                                    ticks: { callback: (val) => Utils.formatCompactCurrency(val), font: { size: 11, family: 'Poppins' } }, 
                                    grid: { color: 'rgba(0,0,0,0.05)' } 
                                },
                                x: { 
                                    grid: { display: false },
                                    ticks: { font: { size: 11, family: 'Poppins', weight: 'bold' } }
                                }
                            },
                            plugins: {
                                legend: { 
                                    position: 'bottom',
                                    labels: { usePointStyle: true, boxWidth: 8, padding: 20, font: { size: 12, family: 'Poppins', weight: 'bold' }, color: '#333' }
                                },
                                tooltip: {
                                    mode: 'index', intersect: false,
                                    backgroundColor: 'rgba(0,0,0,0.8)',
                                    callbacks: {
                                        label: (ctx) => `${ctx.dataset.label}: ${Utils.formatCurrency(ctx.parsed.y)}`
                                    }
                                }
                            }
                        }
                    });
                }
            };

            // --- Gerenciador de Views e UI ---
            const ViewManager = {
                init() {
                    document.getElementById('logoCAF').src = CONFIG.IMAGES.logoCAF;
                    document.getElementById('logoJundiai').src = CONFIG.IMAGES.logoJundiai;
                    document.getElementById('logoPOE').src = CONFIG.IMAGES.logoPOE;

                    document.getElementById('backToMapButton').addEventListener('click', () => this.toggleView('map'));
                    document.getElementById('contractSelector').addEventListener('change', (e) => this.updateContractView(e.target.value));
                    
                    document.getElementById('tab-chart').addEventListener('click', () => this.switchTab('chart'));
                    document.getElementById('tab-table').addEventListener('click', () => this.switchTab('table'));

                    document.getElementById('exportRouteButton').addEventListener('click', () => this.exportRoute());
                    document.getElementById('exportChartPngButton').addEventListener('click', () => this.exportChartPng());
                    document.getElementById('exportTableCsvButton').addEventListener('click', () => this.exportTableCsv());
                    document.getElementById('exportPdfButton').addEventListener('click', () => this.exportPdf());
                    
                    this.populateSelector();
                    this.updateSummary();
                },

                populateSelector() {
                    const selector = document.getElementById('contractSelector');
                    selector.innerHTML = '';
                    window.projectData.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = `${p.id} - ${p.objeto}`;
                        selector.appendChild(opt);
                    });
                },

                updateSummary() {
                    const totalVal = window.projectData.reduce((acc, p) => acc + p.valorAtual, 0);
                    document.getElementById('totalContracts').textContent = window.projectData.length;
                    document.getElementById('totalContractValue').textContent = Utils.formatCompactCurrency(totalVal);
                },

                toggleView(viewName) {
                    const mapEl = document.getElementById('mapView');
                    const dashEl = document.getElementById('dashboardView');
                    if (viewName === 'map') {
                        mapEl.classList.remove('hidden');
                        dashEl.classList.add('hidden');
                        if (state.mapInstance) state.mapInstance.invalidateSize();
                    } else {
                        mapEl.classList.add('hidden');
                        dashEl.classList.remove('hidden');
                    }
                },

                switchTab(tab) {
                    const chartArea = document.getElementById('content-chart');
                    const tableArea = document.getElementById('content-table');
                    const btnChart = document.getElementById('tab-chart');
                    const btnTable = document.getElementById('tab-table');

                    if (tab === 'chart') {
                        chartArea.classList.remove('hidden');
                        tableArea.classList.add('hidden');
                        btnChart.classList.add('active');
                        btnTable.classList.remove('active');
                    } else {
                        chartArea.classList.add('hidden');
                        tableArea.classList.remove('hidden');
                        btnChart.classList.remove('active');
                        btnTable.classList.add('active');
                    }
                },

                showDashboard(contractId) {
                    this.toggleView('dashboard');
                    document.getElementById('contractSelector').value = contractId;
                    this.updateContractView(contractId);
                },

                updateContractView(contractId) {
                    const data = window.projectData.find(p => p.id === contractId);
                    if (!data) return;

                    const detailsContainer = document.getElementById('contractDetails');
                    
                    let dateInfoHtml = '';
                    if (data.predicted_start_date && data.predicted_end_date && data.predicted_start_date !== 'N/A') {
                        const start = Utils.parseDate(data.predicted_start_date);
                        const end = Utils.parseDate(data.predicted_end_date);
                        const duration = Utils.calculateTotalDays(start, end);
                        dateInfoHtml = `<p class="text-xs md:text-sm text-gray-700 mt-0.5">Início: ${data.predicted_start_date} | Fim: ${data.predicted_end_date} | Duração: ${duration} dias</p>`;
                    }
                    
                    let projectImage = '';
                    if (data.objeto.includes("UBS")) projectImage = CONFIG.IMAGES.logoUBS;
                    else if (data.objeto.includes("CECE")) projectImage = CONFIG.IMAGES.logoAtleta;
                    else if (data.objeto.includes("EMEB")) projectImage = CONFIG.IMAGES.logoEscola;

                    const imgTag = projectImage ? `<img src="${projectImage}" class="h-20 md:h-24 object-contain ml-auto"/>` : '';

                    // Using Safe HTML Injection logic
                    detailsContainer.innerHTML = `
                        <div class="flex items-center justify-center flex-wrap text-center space-y-1 w-full">
                            <div class="flex-grow">
                                <p class="text-lg md:text-xl font-bold text-gray-900">Contrato ${Utils.escapeHTML(data.id)}: ${Utils.escapeHTML(data.objeto)}</p>
                                <p class="text-sm md:text-base text-gray-700">
                                    <span class="font-semibold">Empresa:</span> ${Utils.escapeHTML(data.empresa)} | 
                                    <span class="font-semibold">Valor:</span> <span class="font-bold" style="color: #072380;">${Utils.formatCurrency(data.valorAtual)}</span>
                                </p>
                                ${dateInfoHtml}
                            </div>
                            ${imgTag}
                        </div>
                        ${data.observacoes ? `<div class="mt-3 text-center w-full"><p class="text-sm text-[#333333] bg-[rgba(255,204,0,0.3)] p-2 rounded-lg inline-block"><span class="font-bold">Obs:</span> ${Utils.escapeHTML(data.observacoes)}</p></div>` : ''}
                    `;

                    this.renderTables(data);
                    ChartComponent.render(data);
                },

                renderTables(data) {
                    const compBody = document.getElementById('comparativeTableBody');
                    const schedBody = document.getElementById('measurementsTableBody');
                    
                    const hasExecuted = data.grafico && data.grafico.executado && data.grafico.executado.some(v => v !== null);

                    if (hasExecuted) {
                        document.getElementById('comparativeTableContainer').classList.remove('hidden');
                        document.getElementById('predictedScheduleTableContainer').classList.add('hidden');
                        document.getElementById('tab-table').textContent = "Tabela Comparativa";

                        let rowsHtml = '';
                        let prevPrevisto = 0;
                        let prevExecutado = 0;

                        data.grafico.labels.forEach((label, index) => {
                            let previstoAcum = null;
                            if (data.grafico.previstoDataSets) {
                                // Prioridade para o dataset mais recente
                                for (let i = data.grafico.previstoDataSets.length - 1; i >= 0; i--) {
                                    if (data.grafico.previstoDataSets[i]?.data[index] != null) {
                                        previstoAcum = data.grafico.previstoDataSets[i].data[index];
                                        break;
                                    }
                                }
                            } else {
                                previstoAcum = data.grafico.previsto[index];
                            }

                            const executadoAcum = data.grafico.executado[index];
                            const previstoMes = (previstoAcum != null) ? previstoAcum - prevPrevisto : 0;
                            const executadoMes = (executadoAcum != null) ? executadoAcum - prevExecutado : null;

                            let diffCell = '<td class="px-5 py-3 text-sm text-center"></td>';
                            let statusCell = '<td class="px-5 py-3 text-sm text-center"></td>';

                            if (previstoAcum != null && executadoAcum != null) {
                                const diff = executadoAcum - previstoAcum;
                                const status = diff >= 0 ? 'Adiantado' : 'Atrasado';
                                const colorClass = diff >= 0 ? 'text-[#0073a1]' : 'text-[#b80404]';
                                
                                diffCell = `<td class="px-5 py-3 text-sm text-center font-bold ${colorClass}">${Utils.formatCurrencyAndPercentage(diff, data.valorAtual)}</td>`;
                                statusCell = `<td class="px-5 py-3 text-sm text-center font-bold ${colorClass}">${status}</td>`;
                            }

                            rowsHtml += `
                                <tr class="border-b border-slate-200/50 hover:bg-white/50 transition-colors">
                                    <td class="px-5 py-3 text-sm font-medium text-center text-gray-900">${index + 1}</td>
                                    <td class="px-5 py-3 text-sm text-center text-gray-700 font-bold">${label}</td>
                                    <td class="px-5 py-3 text-sm text-center text-gray-600">${Utils.formatCurrency(previstoMes)}</td>
                                    <td class="px-5 py-3 text-sm text-center text-gray-800">${Utils.formatCurrencyAndPercentage(previstoAcum, data.valorAtual)}</td>
                                    <td class="px-5 py-3 text-sm text-center text-gray-600">${executadoMes != null ? Utils.formatCurrency(executadoMes) : '-'}</td>
                                    <td class="px-5 py-3 text-sm text-center text-gray-800 font-bold">${executadoAcum != null ? Utils.formatCurrencyAndPercentage(executadoAcum, data.valorAtual) : '-'}</td>
                                    ${diffCell}
                                    ${statusCell}
                                </tr>
                            `;

                            if (previstoAcum != null) prevPrevisto = previstoAcum;
                            if (executadoAcum != null) prevExecutado = executadoAcum;
                        });

                        compBody.innerHTML = rowsHtml;

                    } else {
                        document.getElementById('comparativeTableContainer').classList.add('hidden');
                        document.getElementById('predictedScheduleTableContainer').classList.remove('hidden');
                        document.getElementById('tab-table').textContent = "Cronograma Previsto";
                        
                        schedBody.innerHTML = data.medicoes.map(m => `
                            <tr class="border-b border-slate-200/50 hover:bg-white/50">
                                <td class="px-5 py-3 text-sm text-center text-gray-900">${Utils.escapeHTML(m.medicao.toString())}</td>
                                <td class="px-5 py-3 text-sm text-center text-gray-700">${m.inicio || '-'} a ${m.fim || '-'}</td>
                                <td class="px-5 py-3 text-sm text-center text-gray-700">${m.ref || '-'}</td>
                                <td class="px-5 py-3 text-sm text-center text-gray-800">${Utils.formatCurrency(m.valor)}</td>
                                <td class="px-5 py-3 text-sm text-center text-gray-800 font-bold">${Utils.formatCurrencyAndPercentage(m.acumulado, data.valorAtual)}</td>
                            </tr>
                        `).join('');
                    }
                },

                exportRoute() {
                    const id = document.getElementById('contractSelector').value;
                    const data = window.projectData.find(p => p.id === id);
                    if(data && data.location) {
                        // Correção da URL do Google Maps
                        const url = `https://www.google.com/maps/dir/${CONFIG.COORDS_PREFEITURA.lat},${CONFIG.COORDS_PREFEITURA.lng}/${data.location.lat},${data.location.lng}`;
                        window.open(url, '_blank');
                    } else {
                        alert("Localização não disponível.");
                    }
                },

                exportChartPng() {
                    if (!state.chartInstance) return alert("Não há gráfico disponível.");
                    const a = document.createElement('a');
                    a.href = state.chartInstance.toBase64Image();
                    a.download = `Grafico_Contrato_${document.getElementById('contractSelector').value}.png`;
                    a.click();
                },

                exportTableCsv() {
                    let table = null;
                    if (!document.getElementById('comparativeTableContainer').classList.contains('hidden')) {
                        table = document.querySelector('#comparativeTableContainer table');
                    } else if (!document.getElementById('predictedScheduleTableContainer').classList.contains('hidden')) {
                        table = document.querySelector('#predictedScheduleTableContainer table');
                    }

                    if (!table) return alert("Nenhuma tabela disponível.");

                    let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
                    const rows = table.querySelectorAll("tr");

                    rows.forEach(row => {
                        const cols = row.querySelectorAll("th, td");
                        const rowData = [];
                        cols.forEach(col => {
                            let text = col.innerText.replace(/(\r\n|\n|\r)/gm, " ").trim();
                            rowData.push(`"${text}"`);
                        });
                        csvContent += rowData.join(";") + "\r\n";
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `Tabela_Contrato_${document.getElementById('contractSelector').value}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                async exportPdf() {
                    const { jsPDF } = window.jspdf;
                    const element = document.getElementById('dashboardView');
                    
                    const buttons = element.querySelectorAll('button, select, label');
                    const originalVisibility = [];
                    buttons.forEach(b => {
                        originalVisibility.push(b.style.visibility);
                        b.style.visibility = 'hidden';
                    });
                    document.getElementById('backToMapButton').style.visibility = 'hidden';

                    try {
                        const canvas = await html2canvas(element, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: '#f0f8ff'
                        });

                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`Relatorio_Obra_${document.getElementById('contractSelector').value}.pdf`);

                    } catch (error) {
                        console.error("Erro ao gerar PDF:", error);
                        alert("Erro ao gerar PDF.");
                    } finally {
                        buttons.forEach((b, i) => b.style.visibility = originalVisibility[i] || 'visible');
                        document.getElementById('backToMapButton').style.visibility = 'visible';
                    }
                }
            };

            const App = {
                init() {
                    Chart.register(ChartDataLabels);
                    ViewManager.init();
                    MapComponent.init();
                }
            };

            return {
                start: () => Auth.init()
            };
        })();

        document.addEventListener('DOMContentLoaded', DashboardApp.start);

    </script>
</body>
</html>

