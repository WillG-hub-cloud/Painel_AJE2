<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard analítico de operações com visualização geoespacial e métricas de desempenho.">
    
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self' https:; 
                   img-src 'self' https: data:; 
                   script-src 'self' https: 'unsafe-inline'; 
                   style-src 'self' https: 'unsafe-inline';">

    <title>Dashboard Analítico de Produção</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     
    <style>
        :root {
            /* Design Tokens */
            --color-primary: #2563eb;    /* blue-600 equivalent */
            --color-bg: #f3f4f6;         /* gray-100 equivalent */
            --color-card: #ffffff;
            --color-text-main: #1f2937;  /* gray-800 equivalent */
            --color-text-light: #6b7280;
            --color-danger: #ef4444;
            --color-success: #10b981;
            
            --spacing-unit: 1.5rem;
            --border-radius: 0.5rem;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            --font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Reset Básico e Tipografia */
        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text-main);
            margin: 0;
            padding: var(--spacing-unit);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout Grid Responsivo */
       .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: var(--spacing-unit);
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
           .container { grid-template-columns: repeat(2, 1fr); }
           .header-section { grid-column: span 2; }
           .full-width { grid-column: span 2; }
        }

        /* Componentes de UI */
       .card {
            background: var(--color-card);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-unit);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0,0,0,0.05);
        }

       .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        h1 { margin: 0; font-size: 1.875rem; font-weight: 700; color: #111827; }
        h2 { margin-top: 0; font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; }

       .btn-primary {
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: opacity 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
        }
        
       .btn-primary:hover { opacity: 0.9; }
       .btn-primary:active { transform: translateY(1px); }
       .btn-primary:focus { outline: 2px solid var(--color-primary); outline-offset: 2px; }

        /* Contêineres de Visualização (Importante: position relative para bibliotecas gráficas) */
       .viz-container {
            position: relative;
            height: 350px;
            width: 100%;
            background-color: #fafafa; /* Placeholder visual */
            border-radius: calc(var(--border-radius) - 2px);
        }

        /* Feedback de Erro (Graceful Degradation) */
       .error-banner {
            grid-column: span 2;
            color: #991b1b;
            padding: 1rem;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: var(--border-radius);
            display: none; /* Oculto por padrão */
            font-weight: 500;
        }

        /* Lista de Logs */
       .log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
       .log-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
            color: var(--color-text-light);
        }
       .log-list li:last-child { border-bottom: none; }

        /* 
          OTIMIZAÇÃO DE IMPRESSÃO (Substitui html2canvas)
          Princípio: Robustez e Fidelidade.
          Gera PDFs perfeitos usando a engine do navegador.
        */
        @media print {
            body { background: white; padding: 0; color: black; }
           .container { display: block; max-width: 100%; }
           .card { 
                box-shadow: none; 
                border: 1px solid #ccc; 
                break-inside: avoid; 
                margin-bottom: 20px;
                page-break-inside: avoid;
            }
           .btn-primary,.no-print { display: none!important; }
           .viz-container { border: 1px solid #eee; }
            h1 { font-size: 24pt; margin-bottom: 20px; }
            /* Garante que cores de fundo (como gráficos) sejam impressas */
            * { -webkit-print-color-adjust: exact!important; print-color-adjust: exact!important; }
        }
    </style>
</head>
<body>

    <div class="container" id="app">
        <div id="error-display" class="error-banner" role="alert" aria-live="assertive"></div>

        <header class="header-section">
            <div>
                <h1>Relatório Executivo de Operações</h1>
                <p style="color: var(--color-text-light); margin: 0.5rem 0 0 0;">Status do Sistema em Tempo Real</p>
            </div>
            <button id="btn-export" class="btn-primary" type="button">
                Imprimir Relatório / Salvar PDF
            </button>
        </header>

        <section class="card">
            <h2>Performance de Vendas (YTD)</h2>
            <div class="viz-container">
                <canvas id="performanceChart" aria-label="Gráfico de barras mostrando vendas mensais" role="img"></canvas>
            </div>
        </section>

        <section class="card">
            <h2>Geolocalização da Frota</h2>
            <div id="map" class="viz-container"></div>
        </section>
        
        <section class="card full-width">
             <h2>Log de Auditoria e Eventos</h2>
             <ul id="activity-log" class="log-list">
                 </ul>
        </section>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
     
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script type="module">
        /**
         * Configuração Centralizada da Aplicação
         * Princípio: Separation of Concerns - Separa dados da lógica.
         */
        const CONFIG = {
            map: {
                initialCoords: [-23.5505, -46.6333], // São Paulo (Exemplo)
                zoom: 13,
                tileLayer: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; OpenStreetMap contributors'
            },
            chart: {
                colors: {
                    primary: 'rgba(37, 99, 235, 0.8)', // blue-600
                    border: 'rgba(37, 99, 235, 1)'
                },
                data: ,
                labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun']
            }
        };

        /**
         * Camada de Manipulação do DOM Segura
         * Princípio: Abstração e Segurança (Mitigação de XSS)
         */
        const DOM = {
            /**
             * Define texto de forma segura usando textContent.
             * @param {string} id - ID do elemento.
             * @param {string} text - Texto a ser inserido.
             */
            setText: (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            },

            /**
             * Exibe mensagens de erro críticas na UI.
             * Princípio: Graceful Degradation / Feedback ao Usuário.
             */
            showError: (msg) => {
                const el = document.getElementById('error-display');
                if (el) {
                    el.textContent = `Erro do Sistema: ${msg}`;
                    el.style.display = 'block';
                    console.error(`[App Error]: ${msg}`);
                }
            },

            /**
             * Adiciona item ao log de forma segura (sem innerHTML).
             * @param {string} msg - Mensagem de log.
             */
            addLog: (msg) => {
                const list = document.getElementById('activity-log');
                if(!list) return;
                
                const li = document.createElement('li');
                const timeSpan = document.createElement('strong');
                
                const now = new Date();
                timeSpan.textContent = ` `;
                
                // Montagem segura via API de Nós do DOM
                li.appendChild(timeSpan);
                li.appendChild(document.createTextNode(msg));
                
                list.insertBefore(li, list.firstChild); // Log mais recente no topo
            }
        };

        /**
         * Módulo de Mapas (Leaflet Adapter)
         */
        const MapModule = {
            init: () => {
                try {
                    if (typeof L === 'undefined') throw new Error("Biblioteca Leaflet não carregada.");
                    
                    const map = L.map('map').setView(CONFIG.map.initialCoords, CONFIG.map.zoom);
                    
                    L.tileLayer(CONFIG.map.tileLayer, {
                        attribution: CONFIG.map.attribution,
                        maxZoom: 19
                    }).addTo(map);

                    // Adiciona marcador de exemplo
                    L.marker(CONFIG.map.initialCoords).addTo(map)
                       .bindPopup('Hub Central de Operações')
                       .openPopup();
                    
                    DOM.addLog('Sistema de mapeamento inicializado.');
                } catch (e) {
                    DOM.showError(`Falha no módulo de mapas: ${e.message}`);
                }
            }
        };

        /**
         * Módulo de Gráficos (Chart.js Adapter)
         */
        const ChartModule = {
            init: () => {
                try {
                    const ctx = document.getElementById('performanceChart');
                    if (!ctx |

| typeof Chart === 'undefined') throw new Error("Contexto gráfico indisponível.");

                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: CONFIG.chart.labels,
                            datasets:
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 800 // Animação suave
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    grid: { color: '#e5e7eb' }
                                },
                                x: {
                                    grid: { display: false }
                                }
                            },
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: { enabled: true }
                            }
                        }
                    });
                    DOM.addLog('Módulo de análise gráfica carregado.');
                } catch (e) {
                    DOM.showError(`Falha no módulo gráfico: ${e.message}`);
                }
            }
        };

        /**
         * Controlador Principal
         * Orquestra a inicialização e eventos globais.
         */
        const App = {
            init: () => {
                console.log('Inicializando Dashboard v2.0 (Production Build)...');
                
                // Inicializa módulos independentes
                MapModule.init();
                ChartModule.init();
                
                // Configura Handlers de Eventos
                App.setupEventListeners();
                
                DOM.addLog('Aplicação pronta para uso.');
            },

            setupEventListeners: () => {
                const btn = document.getElementById('btn-export');
                if(btn) {
                    btn.addEventListener('click', () => {
                        DOM.addLog('Iniciando processo de impressão...');
                        // Aciona o diálogo nativo do navegador (melhor fidelidade que html2canvas)
                        window.print();
                    });
                }
            }
        };

        // Bootstrap seguro quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', App.init);
        } else {
            App.init();
        }

    </script>
</body>
</html>
